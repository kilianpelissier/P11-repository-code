pipeline {
    agent any

    environment {
        // Utiliser JDK 8u221 et Maven 3.6.3
        MAVEN_HOME = tool 'Maven 3.8.8' // Assurez-vous que Maven 3.6.3 est installé sur votre Jenkins et configuré avec ce nom
        JAVA_HOME = tool 'JDK 21.0.2' // Assurez-vous que JDK 8u221 est installé sur votre Jenkins et configuré avec ce nom
    }

    stages {
        stage('Checkout') {
            steps {
                // Récupérer le code source depuis le dépôt Git
                git branch: 'main', url: 'https://github.com/kilianpelissier/P11-repository-code.git'
            }
        }

        stage('Build') {
            steps {
                // Construire le projet avec Maven
                dir('Backend/api') {
                    sh "${MAVEN_HOME}/bin/mvn clean install"
                }
            }
        }

        stage('Test') {
            steps {
                // Exécuter les tests unitaires
                dir('Backend/api') {
                    sh "${MAVEN_HOME}/bin/mvn test"
                }
            }
            post {
                always {
                    // Publier les résultats des tests, même si l'étape échoue
                    dir('Backend/api') {
                        junit '**/target/surefire-reports/*.xml'
                    }
                }
            }
        }

        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                // Déployer l'application (non requis au niveau de ce projet)
                sh 'echo "Déploiement de l\'application..."'
            }
        }
    }

    post {
        always {
            // Nettoyer l'espace de travail après la construction
            cleanWs()
        }
    }
}